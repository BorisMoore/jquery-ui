<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Grid: Selecting</title>
	<link rel="stylesheet" href="../themes/base/jquery.ui.all.css">
	<link rel="stylesheet" href="../grid-spf/grid.css">
	<link rel="stylesheet" href="detail.css">
	<script src="../jquery-1.5.1.js"></script>
	<script src="../external/jquery.tmpl.js"></script>
	<script src="../external/jquery.mousewheel-3.0.4.js"></script>
	<script src="../ui/jquery.ui.core.js"></script>
	<script src="../ui/jquery.ui.widget.js"></script>
	<script src="../ui/jquery.ui.mouse.js"></script>
	<script src="../ui/jquery.ui.button.js"></script>
	<script src="../ui/jquery.ui.selectable.js"></script>
	<script src="../ui/jquery.ui.spinner.js"></script>
	<script src="../grid-spf/datasource.js"></script>
	<script src="../grid-spf/datasource-local.js"></script>
	<script src="../grid-spf/grid.js"></script>
	<script src="../grid-spf/pager.js"></script>
	<script>
	var localDevelopers;
	$.ajax({
		dataType: "json",
		url: "../grid-spf/developers.json",
		async: false,
		success: function( result ) {
			localDevelopers = result;
		}
	});

	$(function() {
		var developers = $.ui.localDatasource({
			input: localDevelopers,
			paging: {
				limit: 4
			}
		});

		var developersGrid = $( "#developers-grid" ).grid({
			source: developers,
			selectedData: [],
			refresh: function() {
				$( this ).find( "tbody tr" ).addClass( function() {
					if ( $.inArray( $.tmplItem( this ).data, selectedData ) >= 0) {
						return "ui-selected";
					}
				});
			}
		}).data( "grid" );
		
		var selectedData = developersGrid.options.selectedData;

		$( "#developers-grid" ).selectable({
			filter: "tr",
			start: function( ev, eventArgs ) {
				if ( !ev.ctrlKey ) {
					// If ctrlKey not true, remove any other items in selectedData - which may be on other pages than the current one.
					selectedData.splice( 0, selectedData.length );
				}
			},
			selected: function( ev, eventArgs ) {
				var dataItem = $.tmplItem( eventArgs.selected ).data;
				index = $.inArray( dataItem, selectedData );
				if ( index == -1 ) {
					selectedData.push( dataItem );
				}
			},
			unselected: function( ev, eventArgs ) {
				var index = $.inArray( $.tmplItem( eventArgs.unselected ).data, selectedData );
				if ( index >= 0 ) {
					selectedData.splice( index, 1 );
				}
			},
			stop: function( ev, eventArgs ) {
				updateSelection();
			}
		});
		
		$( ".clearSelection" ).click(function() {
			selectedData.splice( 0, selectedData.length );
			updateSelection();
			developersGrid.element.find("tbody tr").removeClass( "ui-selected" ); // Avoid re-rendering the grid, for better perf, and to maintain state. 
			// Logging
//			$( "<div></div>" ).text("Cleared selection").appendTo( ".log" );
		});
		
		$( ".invertSelection" ).click(function() {
			var item, inverted = localDevelopers.slice( 0 );
			while ( item = selectedData.pop() ) {
				var index = $.inArray( item, inverted );
				inverted.splice( index, 1 );
			}
			inverted.unshift( 0 );
			inverted.unshift( 0 );
			[].splice.apply( selectedData, inverted );
			updateSelection();
			developersGrid.element.find("tbody tr").addClass( function( index, currentClass ) {
				// Avoid re-rendering the grid, for better perf, and to maintain state. 
				if ( currentClass === "ui-selected" ) {
					$( this ).removeClass( "ui-selected" );
				} else {
					return "ui-selected";
				} 
			});
			// Logging
//			$( "<div></div>" ).text("Inverted selection").appendTo( ".log" );
		});
		
		$( ".removeSelected" ).click(function() {
			var item;
			while ( item = selectedData.pop() ) {
				var rem = localDevelopers.splice( $.inArray( item, localDevelopers ), 1 );
				// Logging
//				$( "<div></div>" ).text( "Removed " + rem[0].firstName + " " + rem[0].lastName ).appendTo( ".log" );
			}
			updateSelection();
			developers.refresh();
		});

		$( "#developers-pager" ).pager({
			source: developers
		});

		developers.refresh();

		function updateSelection() {
			$("#developers-detail").empty();
			$("#detail-template").tmpl( selectedData )
				.appendTo( "#developers-detail" );
		}
	});
	</script>
	<style>
	.ui-selecting td { background: #eef; }
	.ui-selected td { background: #ddf; }
	</style>
</head>
<body>

<h1>Grid with selectable rows</h1>

<p id="developers-pager">
	<button data-page="first">First</button>
	<button data-page="prev">Prev</button>
	<button data-page="prevStep">-1</button>
	<span>
		Page <input class="current" size="4"/>/<span class="total">0</span>,
		Total records <span class="totalRecords">0</span>
	</span>
	<button data-page="nextStep">+1</button>
	<button data-page="next">Next</button>
	<button data-page="last">Last</button>
</p>

<p>
	<button class="clearSelection">Clear selection</button>
	<button class="invertSelection">Invert selection</button>
	<button class="removeSelected">Remove selected</button>
</p>

<table id="developers-grid">
	<thead>
		<tr>
			<th data-field="firstName">First Name</th>
			<th data-field="lastName">Last Name</th>
			<th data-field="country">Country</th>
			<th data-field="bitcoins" data-type="number">Bitcoins</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>

<div id="developers-detail"></div>

<script id="detail-template" type="text/x-jquery-tmpl">
	<div>${firstName} ${lastName}: ${country}</div>
</script>

<div class="log"></div>

</body>
</html>
